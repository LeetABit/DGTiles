<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<TrustFrameworkPolicy
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
  PolicySchemaVersion="0.3.0.0"
  TenantId="dgtiles.onmicrosoft.com"
  PolicyId="B2C_1A_COMMON"
  PublicPolicyUri="http://dgtiles.onmicrosoft.com/B2C_1A_COMMON"
  DeploymentMode="Development"
  UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights">
  
  <BuildingBlocks>
    <ClaimsSchema>

      <ClaimType Id="issuer">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="sub">
        <DisplayName>Subject</DisplayName>
        <DataType>string</DataType>
        <DefaultPartnerClaimTypes>
          <Protocol Name="OpenIdConnect" PartnerClaimType="sub" />
        </DefaultPartnerClaimTypes>
        <UserHelpText/>
      </ClaimType>
        
      <ClaimType Id="subjectWithIssuerCollection">
        <DisplayName>subjectWithIssuerCollection</DisplayName>
        <DataType>stringCollection</DataType>
      </ClaimType>

      <ClaimType Id="numericUserId">
        <DisplayName>Numeric user Identifier</DisplayName>
        <DataType>long</DataType>
      </ClaimType>

      <ClaimType Id="subjectWithIssuer">
        <DisplayName>subjectWithIssuer</DisplayName>
        <DataType>string</DataType>
        <AdminHelpText />
        <UserHelpText />
      </ClaimType>
      
    </ClaimsSchema>
      
    <ClaimsTransformations>
      <ClaimsTransformation Id="CreateIssuerUserId" TransformationMethod="ConvertNumberToStringClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="numericUserId" TransformationClaimType="inputClaim" />
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="sub" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CreateSubjectWithIssuerFromIssuer" TransformationMethod="AddItemToStringCollection">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="sub" TransformationClaimType="item" />
          <InputClaim ClaimTypeReferenceId="subjectWithIssuerCollection" TransformationClaimType="collection" />
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="subjectWithIssuerCollection" TransformationClaimType="collection" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="AddSubjectToSubjectWithIssuer" TransformationMethod="AddItemToStringCollection">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="issuer" TransformationClaimType="item" />
          <InputClaim ClaimTypeReferenceId="subjectWithIssuerCollection" TransformationClaimType="collection" />
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="subjectWithIssuerCollection" TransformationClaimType="collection" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="JoinIssuerWithSubject" TransformationMethod="StringJoin">
        <InputClaims>
        <InputClaim ClaimTypeReferenceId="subjectWithIssuerCollection" TransformationClaimType="inputClaim" />
        </InputClaims>
        <InputParameters>
          <InputParameter DataType="string" Id="delimiter" Value=":" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="subjectWithIssuer" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="HashUserId" TransformationMethod="Hash">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="subjectWithIssuer" TransformationClaimType="plaintext" />
          <InputClaim ClaimTypeReferenceId="subjectWithIssuer" TransformationClaimType="salt" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="randomizerSecret" DataType="string" Value="B2C_1A_AccountTransformSecret" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="sub" TransformationClaimType="hash" />
        </OutputClaims>
      </ClaimsTransformation>
    </ClaimsTransformations>
  </BuildingBlocks>

  <ClaimsProviders>
    <ClaimsProvider>
      <!-- The technical profile(s) defined in this section is required by the framework to be included in all policies. -->
      <DisplayName>Trustframework Policy Engine TechnicalProfiles</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="TpEngine_c3bd4fe2-1775-4013-b91d-35f16d377d13">
          <DisplayName>Trustframework Policy Engine Default Technical Profile</DisplayName>
          <Protocol Name="None" />
          <Metadata>
            <Item Key="url">{service:te}</Item>
          </Metadata>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <!-- 
      The technical profile(s) defined in this section specify Token Issuers that are used by the required SendClaims step of a User Journey 
      to return a token to the caller.
      -->
      <DisplayName>Token Issuer Technical Profiles</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="JwtIssuer">
          <DisplayName>JWT Issuer</DisplayName>
          <Protocol Name="None" />
          <OutputTokenFormat>JWT</OutputTokenFormat>
          <Metadata>
            <Item Key="client_id">{service:te}</Item>
            <Item Key="SendTokenResponseBodyWithJsonNumbers">true</Item>
            <Item Key="issuer_refresh_token_user_identity_claim_type">sub</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
            <Key Id="issuer_refresh_token_key" StorageReferenceId="B2C_1A_TokenEncryptionKeyContainer" />
          </CryptographicKeys>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider> 
  </ClaimsProviders>

</TrustFrameworkPolicy>
