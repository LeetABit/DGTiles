<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<TrustFrameworkPolicy
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
  PolicySchemaVersion="0.3.0.0"
  TenantId="dgtiles.onmicrosoft.com"
  PolicyId="B2C_1A_FACEBOOK"
  PublicPolicyUri="http://dgtiles.onmicrosoft.com/B2C_1A_FACEBOOK"
  DeploymentMode="Development"
  UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights">
  
  <BasePolicy>
    <TenantId>dgtiles.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_Common</PolicyId>
  </BasePolicy>

  <ClaimsProviders>
    <ClaimsProvider>
      <Domain>facebook.com</Domain>
      <DisplayName>Facebook</DisplayName>

      <TechnicalProfiles>
        <TechnicalProfile Id="Facebook-OAUTH2">
          <DisplayName>Facebook</DisplayName>
          <Protocol Name="OAuth2" />
          <Metadata>
            <Item Key="ProviderName">facebook.com</Item>
            <Item Key="authorization_endpoint">https://www.facebook.com/dialog/oauth</Item>
            <Item Key="AccessTokenEndpoint">https://graph.facebook.com/oauth/access_token</Item>
            <Item Key="HttpBinding">GET</Item>
            <Item Key="UsePolicyInRedirectUri">0</Item>
            <Item Key="client_id">300225215495897</Item>
            <Item Key="auth_type">reauthenticate</Item>
            <Item Key="scope">public_profile</Item>
            <Item Key="prompt">select_account</Item>
            <Item Key="ClaimsEndpoint">https://graph.facebook.com/me?fields=id</Item>
            <Item Key="AccessTokenResponseFormat">json</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="client_secret" StorageReferenceId="B2C_1A_FacebookSecret" />
          </CryptographicKeys>
          <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="sub" PartnerClaimType="id" />
            <OutputClaim ClaimTypeReferenceId="issuer" DefaultValue="facebook-oauth" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CreateSubjectWithIssuerFromIssuer" />
            <OutputClaimsTransformation ReferenceId="AddSubjectToSubjectWithIssuer" />
            <OutputClaimsTransformation ReferenceId="JoinIssuerWithSubject" />
            <OutputClaimsTransformation ReferenceId="HashUserId" />
          </OutputClaimsTransformations>
            </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
  </ClaimsProviders>

  <UserJourneys>
    <UserJourney Id="FacebookJourney">
      <OrchestrationSteps>

        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="FacebookExchange" TechnicalProfileReferenceId="Facebook-OAUTH2" />
          </ClaimsExchanges>
        </OrchestrationStep>
        
        <OrchestrationStep Order="2" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

      </OrchestrationSteps>
    </UserJourney>
  </UserJourneys>

  <RelyingParty>
    <DefaultUserJourney ReferenceId="FacebookJourney"/>
    <TechnicalProfile Id="FacebookPolicyProfile">
      <DisplayName>Facebook Policy Profile</DisplayName>
      <Protocol Name="OpenIdConnect" />
      <OutputClaims>
        <OutputClaim ClaimTypeReferenceId="sub" />
      </OutputClaims>
      <SubjectNamingInfo ClaimType="sub" />
    </TechnicalProfile>
  </RelyingParty>  
</TrustFrameworkPolicy>
