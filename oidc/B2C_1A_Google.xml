<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<TrustFrameworkPolicy
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
  PolicySchemaVersion="0.3.0.0"
  TenantId="dgtiles.onmicrosoft.com"
  PolicyId="B2C_1A_GOOGLE"
  PublicPolicyUri="http://dgtiles.onmicrosoft.com/B2C_1A_GOOGLE"
  DeploymentMode="Development"
  UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights">
  
  <BasePolicy>
    <TenantId>dgtiles.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_Common</PolicyId>
  </BasePolicy>

  <ClaimsProviders>
    <ClaimsProvider>
      <Domain>google.com</Domain>
      <DisplayName>Google</DisplayName>

      <TechnicalProfiles>
        <TechnicalProfile Id="Google-OIDC">
          <DisplayName>Google</DisplayName>
          <Protocol Name="OpenIdConnect" />
          <Metadata>
            <Item Key="METADATA">https://accounts.google.com/.well-known/openid-configuration</Item>
            <Item Key="scope">openid</Item>
            <Item Key="response_types">id_token</Item>
            <Item Key="response_mode">form_post</Item>
            <Item Key="prompt">select_account</Item>
            <Item Key="HttpBinding">POST</Item>
            <Item Key="UsePolicyInRedirectUri">false</Item>
            <Item Key="client_id">843350363689-4nq0rjr3f8t47lklnqoqhvk12sgdip00.apps.googleusercontent.com</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="client_secret" StorageReferenceId="B2C_1A_GoogleSecret" />
          </CryptographicKeys>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="sub" />
            <OutputClaim ClaimTypeReferenceId="issuer" DefaultValue="google" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CreateSubjectWithIssuerFromIssuer" />
            <OutputClaimsTransformation ReferenceId="AddSubjectToSubjectWithIssuer" />
            <OutputClaimsTransformation ReferenceId="JoinIssuerWithSubject" />
            <OutputClaimsTransformation ReferenceId="HashUserId" />
          </OutputClaimsTransformations>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
  </ClaimsProviders>

  <UserJourneys>
    <UserJourney Id="GoogleJourney">
      <OrchestrationSteps>

        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="GoogleExchange" TechnicalProfileReferenceId="Google-OIDC" />
          </ClaimsExchanges>
        </OrchestrationStep>
        
        <OrchestrationStep Order="2" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

      </OrchestrationSteps>
    </UserJourney>
  </UserJourneys>

  <RelyingParty>
    <DefaultUserJourney ReferenceId="GoogleJourney"/>
    <TechnicalProfile Id="GooglePolicyProfile">
      <DisplayName>Google Policy Profile</DisplayName>
      <Protocol Name="OpenIdConnect" />
      <OutputClaims>
        <OutputClaim ClaimTypeReferenceId="sub" />
      </OutputClaims>
      <SubjectNamingInfo ClaimType="sub" />
    </TechnicalProfile>
  </RelyingParty>

</TrustFrameworkPolicy>
